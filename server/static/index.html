<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <title>Roblox Block Coding Prototype</title>
  <script src="./blockly_compressed.js"></script>
  <script src="./blocks_compressed.js"></script>
  <script src="./lua_compressed.js"></script>
  <script src="./en.js"></script>
  <style>
    body {
      background-color: #fff;
      font-family: sans-serif;
    }

    h1 {
      font-weight: normal;
      font-size: 140%;
    }
  </style>
</head>

<body>
  <h1>Roblox Block Coding Prototype</h1>
  <select id="codefile" onchange="onCodefileChanged()">
    <option value="">Select a file</option>
  </select>
  <p>
    <button onclick="showCode()">Show Lua</button>
    <button onclick="saveToRoblox()">Save to Roblox Studio</button>
    <button onclick="newBloxScript()">New Blox Script</button>
    <button onclick="deleteBloxScript()">Delete Blox Script</button>
    <button onclick="refresh()">Refresh</button>
  </p>
  <hr />

  <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>

  <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
    <category name="Logic" colour="%{BKY_LOGIC_HUE}">
      <block type="controls_if"></block>
      <block type="logic_compare"></block>
      <block type="logic_operation"></block>
      <block type="logic_negate"></block>
      <block type="logic_boolean"></block>
    </category>
    <category name="Loops" colour="%{BKY_LOOPS_HUE}">
      <block type="controls_repeat_ext">
        <value name="TIMES">
          <block type="math_number">
            <field name="NUM">10</field>
          </block>
        </value>
      </block>
      <block type="controls_whileUntil"></block>
    </category>
    <category name="Math" colour="%{BKY_MATH_HUE}">
      <block type="math_number">
        <field name="NUM">123</field>
      </block>
      <block type="math_arithmetic"></block>
      <block type="math_single"></block>
    </category>
    <category name="Text" colour="%{BKY_TEXTS_HUE}">
      <block type="text"></block>
      <block type="text_length"></block>
      <block type="text_print"></block>
    </category>
  </xml>

  <script>
    var demoWorkspace = Blockly.inject('blocklyDiv',
      {
        media: '../../media/',
        toolbox: document.getElementById('toolbox')
      });
    // Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
    //                            demoWorkspace);

    function showCode() {
      // Generate Lua code and display it.
      Blockly.Lua.INFINITE_LOOP_TRAP = null;
      var code = Blockly.Lua.workspaceToCode(demoWorkspace);
      alert(code);
    }

    async function sendMessage(message) {
      await fetch("/messages/studio", {
        method: "POST",
        body: JSON.stringify(message)
      })
    }

    async function saveToRoblox() {
      // save blox source
      const codefile_select = document.getElementById("codefile")
      const codefile = codefile_select.value
      const bloxCodeDom = Blockly.Xml.workspaceToDom(demoWorkspace)
      const bloxCode = Blockly.Xml.domToText(bloxCodeDom)
      await sendMessage({
        event_type: "SetGlobalBloxScript",
        event_data: {
          name: codefile,
          value: bloxCode
        }
      })
      // save Lua source
      const luafile = codefile.split(".blox")[0]
      Blockly.Lua.INFINITE_LOOP_TRAP = null;
      const luaCode = Blockly.Lua.workspaceToCode(demoWorkspace)
      await sendMessage({
        event_type: "SetGlobalLuaScript",
        event_data: {
          name: luafile,
          value: luaCode,
        }
      })
    }

    async function loadCodefile(codefile) {
      await sendMessage({
        event_type: "GetGlobalBloxScript",
        event_data: {
          name: codefile
        }
      })
    }

    async function onCodefileChanged() {
      const codefile_select = document.getElementById("codefile")
      const codefile = codefile_select.value
      console.log(`codefile changed: ${codefile}`)
      if (codefile) {
        await loadCodefile(codefile)
      }
    }

    function onCodefileReturned(event_data) {
      // TODO: ensure this is the right file by checking name
      const codefileXml = event_data.result
      demoWorkspace.clear()
      let codefileDom;
      if (codefileXml == "") {
        codefileDom = Blockly.Xml.textToDom(`<xml xmlns="https://developers.google.com/blockly/xml"></xml>`)
      } else {
        codefileDom = Blockly.Xml.textToDom(codefileXml)
      }
      Blockly.Xml.domToWorkspace(codefileDom,
        demoWorkspace);
    }

    async function refresh() {
      await fetch("/messages/studio", {
        method: "POST",
        body: JSON.stringify({
          "event_type": "ListGlobalBloxScripts"
        })
      })
    }


    function onRefresh(event_data) {
      const codefile_select = document.getElementById("codefile")
      let options = `<option value="">Select a file</option>`
      for (let item of event_data.items) {
        options += `<option value="${item}">${item}</option>`
      }
      codefile_select.innerHTML = options
    }

    function newBloxScript() {
      const filename = prompt("Enter a name for the new blox script")
      if (filename) {
        sendMessage({
          event_type: "CreateGlobalBloxScript",
          event_data: {
            name: filename + ".blox"
          }
        })
      }
    }

    function deleteBloxScript() {
      if (!confirm("Are you sure you want to delete this blox code file?")) {
        return
      }
      const codefile_select = document.getElementById("codefile")
      sendMessage({
        event_type: "DeleteGlobalBloxScript",
        event_data: {
          name: codefile_select.value
        }
      })
      const luafile = codefile_select.value.split(".blox")[0]
      sendMessage({
        event_type: "DeleteGlobalLuaScript",
        event_data: {
          name: luafile
        }
      })
    }

    function onBloxScriptCreated(event_data) {
      const codefile_select = document.getElementById("codefile")
      const name = event_data.name
      codefile_select.innerHTML += `<option value="${name}">${name}</option>`
      codefile_select.value = name
      demoWorkspace.clear()
      saveToRoblox()
    }

    function onBloxScriptDeleted(event_data) {
      refresh()
    }

    refresh()

    window.setInterval(async () => {
      let resp = await fetch("/messages/blox");
      const result = await resp.json()
      if (result.messages.length > 0) {
        for (let message of result.messages) {
          console.log(message);
          switch (message.event_type) {
            case "GlobalBloxScriptDeleted":
              onBloxScriptDeleted(message.event_data);
              break;
            case "GlobalBloxScripts":
              onRefresh(message.event_data)
              break
            case "GlobalBloxScriptCreated":
              onBloxScriptCreated(message.event_data);
              break;
            case "GlobalBloxScript":
              onCodefileReturned(message.event_data)
              break
          }
        }
      }
    }, 1000);
  </script>

</body>

</html>