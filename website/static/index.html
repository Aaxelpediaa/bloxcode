<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Roblox Block Coding Prototype</title>
    <script src="./blockly_compressed.js"></script>
    <script src="./blocks_compressed.js"></script>
    <script src="./lua_compressed.js"></script>
    <script src="./en.js"></script>
    <style>
        body {
            background-color: #fff;
            font-family: sans-serif;
        }
        
        h1 {
            font-weight: normal;
            font-size: 140%;
        }
    </style>
</head>

<body>
    <h1>Roblox Block Coding Prototype</h1>
    <select id="codefile" onchange="onCodefileChanged()">
    <option value="">Select a file</option>
  </select>
    <button id="connect" onclick="onConnect()">Connect to Roblox Studio</button>
    <p id="controls" style="display: none">
        <button onclick="showCode()">Show Lua</button>
        <button onclick="saveToRoblox()">Save to Roblox Studio</button>
        <button onclick="newBloxScript()">New Blox Script</button>
        <button onclick="deleteBloxScript()">Delete Blox Script</button>
        <button onclick="refresh()">Refresh</button>
    </p>
    <hr />

    <div id="blocklyDiv" style="height: 480px; width: 600px;"></div>

    <xml xmlns="https://developers.google.com/blockly/xml" id="toolbox" style="display: none">
        <category name="Logic" colour="%{BKY_LOGIC_HUE}">
            <block type="controls_if"></block>
            <block type="logic_compare"></block>
            <block type="logic_operation"></block>
            <block type="logic_negate"></block>
            <block type="logic_boolean"></block>
        </category>
        <category name="Loops" colour="%{BKY_LOOPS_HUE}">
            <block type="controls_repeat_ext">
                <value name="TIMES">
                    <block type="math_number">
                        <field name="NUM">10</field>
                    </block>
                </value>
            </block>
            <block type="controls_whileUntil"></block>
        </category>
        <category name="Math" colour="%{BKY_MATH_HUE}">
            <block type="math_number">
                <field name="NUM">123</field>
            </block>
            <block type="math_arithmetic"></block>
            <block type="math_single"></block>
        </category>
        <category name="Text" colour="%{BKY_TEXTS_HUE}">
            <block type="text"></block>
            <block type="text_length"></block>
            <block type="text_print"></block>
        </category>
        <category name="Variables" custom="VARIABLE" colour="%{BKY_VARIABLES_HUE}">
        </category>
        <category name="Functions" custom="PROCEDURE" colour="%{BKY_PROCEDURES_HUE}">
        </category>
        <category name="Control">
            <block type="wait"></block>
        </category>
        <category name="Instance">
            <block type="instance_find_first_child"></block>
            <block type="instance_wait_for_child"></block>
            <block type="instance_destroy"></block>
            <block type="instance_is_a_part"></block>
        </category>
        <category name="Part">
            <block type="part_set_brickcolor"></block>
            <block type="part_event_connect"></block>
        </category>
    </xml>

    <script>
        var demoWorkspace = Blockly.inject('blocklyDiv', {
            media: '../../media/',
            toolbox: document.getElementById('toolbox')
        });
        // Blockly.Xml.domToWorkspace(document.getElementById('startBlocks'),
        //                            demoWorkspace);

        // define custom blocks
        Blockly.Blocks['instance_find_first_child'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("find first child")
                    .appendField(new Blockly.FieldVariable("workspace"), "INSTANCE")
                    .appendField(new Blockly.FieldTextInput("<name>"), "NAME");
                this.setOutput(true, "Instance");
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Lua['instance_find_first_child'] = function(block) {
            var variable_instance = Blockly.Lua.variableDB_.getName(block.getFieldValue('INSTANCE'), Blockly.Variables.NAME_TYPE);
            var text_name = block.getFieldValue('NAME');
            // TODO: Assemble Lua into code variable.
            var code = `${variable_instance}:FindFirstChild("${text_name}")`;
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.Lua.ORDER_NONE];
        };

        Blockly.Blocks['instance_is_a_part'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("is a Part")
                    .appendField(new Blockly.FieldVariable("workspace"), "INSTANCE");
                this.setOutput(true, "Boolean");
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        }

        Blockly.Lua['instance_is_a_part'] = function(block) {
            var variable_instance = Blockly.Lua.variableDB_.getName(block.getFieldValue('INSTANCE'), Blockly.Variables.NAME_TYPE);
            // TODO: Assemble Lua into code variable.
            var code = `${variable_instance}:isA("Part")`;
            // TODO: Change ORDER_NONE to the correct strength.
            return [code, Blockly.Lua.ORDER_NONE];
        };

        Blockly.Blocks['part_set_brickcolor'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("set brick color")
                    .appendField(new Blockly.FieldVariable("item"), "INSTANCE")
                    .appendField("R")
                    .appendField(new Blockly.FieldNumber(0, 0, 1), "R")
                    .appendField("G")
                    .appendField(new Blockly.FieldNumber(0, 0, 1), "G")
                    .appendField("B")
                    .appendField(new Blockly.FieldNumber(0, 0, 1), "B");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Lua['part_set_brickcolor'] = function(block) {
            var variable_instance = Blockly.Lua.variableDB_.getName(block.getFieldValue('INSTANCE'), Blockly.Variables.NAME_TYPE);
            var number_r = block.getFieldValue('R');
            var number_g = block.getFieldValue('G');
            var number_b = block.getFieldValue('B');
            var code = `${variable_instance}.BrickColor = BrickColor.new(${number_r}, ${number_g}, ${number_b})\n`;
            return code;
        };

        Blockly.Blocks['wait'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("wait")
                    .appendField(new Blockly.FieldNumber(0, 0), "AMOUNT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Lua['wait'] = function(block) {
            var number_amount = block.getFieldValue('AMOUNT');
            var code = `wait(${number_amount})\n`;
            return code;
        };

        Blockly.Blocks['instance_destroy'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("Instance:destroy")
                    .appendField(new Blockly.FieldVariable("item"), "INSTANCE");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        }

        Blockly.Lua['instance_destroy'] = function(block) {
            var variable_instance = Blockly.Lua.variableDB_.getName(block.getFieldValue('INSTANCE'), Blockly.Variables.NAME_TYPE);
            var code = `${variable_instance}:Destroy()\n`
            return code;
        };

        Blockly.Blocks['instance_wait_for_child'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("wait for child")
                    .appendField(new Blockly.FieldVariable("workspace"), "INSTANCE");
                this.appendValueInput("NAME")
                    .setCheck("String")
                    .appendField("name");
                this.appendDummyInput()
                    .appendField("timeout")
                    .appendField(new Blockly.FieldNumber(1), "TIMEOUT");
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Lua['instance_wait_for_child'] = function(block) {
            var variable_instance = Blockly.Lua.variableDB_.getName(block.getFieldValue('INSTANCE'), Blockly.Variables.NAME_TYPE);
            var value_name = Blockly.Lua.valueToCode(block, 'NAME', Blockly.Lua.ORDER_ATOMIC);
            var number_timeout = block.getFieldValue('TIMEOUT');
            var code = `${variable_instance}:WaitForChild(${value_name}, ${number_timeout})\n`;
            return code;
        };

        Blockly.Blocks['part_event_connect'] = {
            init: function() {
                this.appendDummyInput()
                    .appendField("part connect event")
                    .appendField(new Blockly.FieldVariable("item"), "INSTANCE")
                    .appendField(new Blockly.FieldDropdown([
                        ["Touched", "Touched"]
                    ]), "EVENT");
                this.appendStatementInput("NAME")
                    .setCheck(null);
                this.setPreviousStatement(true, null);
                this.setNextStatement(true, null);
                this.setColour(230);
                this.setTooltip("");
                this.setHelpUrl("");
            }
        };

        Blockly.Lua['part_event_connect'] = function(block) {
            var variable_instance = Blockly.Lua.variableDB_.getName(block.getFieldValue('INSTANCE'), Blockly.Variables.NAME_TYPE);
            var dropdown_event = block.getFieldValue('EVENT');
            var statements_name = Blockly.Lua.statementToCode(block, 'NAME');
            var code = `${variable_instance}.${dropdown_event}:Connect(function()
  ${statements_name}
end)\n`;
            return code;
        };

        const backendUrl = "https://7iokpqos42.execute-api.us-west-2.amazonaws.com/prod"

        let connectionInfo;

        function showCode() {
            // Generate Lua code and display it.
            Blockly.Lua.INFINITE_LOOP_TRAP = null;
            var code = Blockly.Lua.workspaceToCode(demoWorkspace);
            alert(code);
        }

        async function sendMessage(message) {
            await fetch(`${backendUrl}/messages/${connectionInfo.queues.blox}`, {
                method: "POST",
                body: JSON.stringify(message),
                headers: {
                    authcode: connectionInfo.auth_code
                }
            })
        }

        async function saveToRoblox() {
            // save blox source
            const codefile_select = document.getElementById("codefile")
            const codefile = codefile_select.value
            const bloxCodeDom = Blockly.Xml.workspaceToDom(demoWorkspace)
            const bloxCode = Blockly.Xml.domToText(bloxCodeDom)
            await sendMessage({
                    event_type: "SetGlobalBloxScript",
                    event_data: {
                        name: codefile,
                        value: bloxCode
                    }
                })
                // save Lua source
            const luafile = codefile.split(".blox")[0]
            Blockly.Lua.INFINITE_LOOP_TRAP = null;
            const luaCode = Blockly.Lua.workspaceToCode(demoWorkspace)
            await sendMessage({
                event_type: "SetGlobalLuaScript",
                event_data: {
                    name: luafile,
                    value: luaCode,
                }
            })
        }

        async function loadCodefile(codefile) {
            await sendMessage({
                event_type: "GetGlobalBloxScript",
                event_data: {
                    name: codefile
                }
            })
        }

        async function onCodefileChanged() {
            const codefile_select = document.getElementById("codefile")
            const codefile = codefile_select.value
            console.log(`codefile changed: ${codefile}`)
            if (codefile) {
                await loadCodefile(codefile)
            }
        }

        function onCodefileReturned(event_data) {
            // TODO: ensure this is the right file by checking name
            const codefileXml = event_data.result
            demoWorkspace.clear()
            let codefileDom;
            if (codefileXml == "") {
                codefileDom = Blockly.Xml.textToDom(`<xml xmlns="https://developers.google.com/blockly/xml"></xml>`)
            } else {
                codefileDom = Blockly.Xml.textToDom(codefileXml)
            }
            Blockly.Xml.domToWorkspace(codefileDom,
                demoWorkspace);
        }

        async function refresh() {
            await sendMessage({
                event_type: "ListGlobalBloxScripts"
            })
        }


        function onRefresh(event_data) {
            const codefile_select = document.getElementById("codefile")
            let options = `<option value="">Select a file</option>`
            for (let item of event_data.items) {
                options += `<option value="${item}">${item}</option>`
            }
            codefile_select.innerHTML = options
        }

        function newBloxScript() {
            const filename = prompt("Enter a name for the new blox script")
            if (filename) {
                sendMessage({
                    event_type: "CreateGlobalBloxScript",
                    event_data: {
                        name: filename + ".blox"
                    }
                })
            }
        }

        function deleteBloxScript() {
            if (!confirm("Are you sure you want to delete this blox code file?")) {
                return
            }
            const codefile_select = document.getElementById("codefile")
            sendMessage({
                event_type: "DeleteGlobalBloxScript",
                event_data: {
                    name: codefile_select.value
                }
            })
            const luafile = codefile_select.value.split(".blox")[0]
            sendMessage({
                event_type: "DeleteGlobalLuaScript",
                event_data: {
                    name: luafile
                }
            })
        }

        function onBloxScriptCreated(event_data) {
            const codefile_select = document.getElementById("codefile")
            const name = event_data.name
            codefile_select.innerHTML += `<option value="${name}">${name}</option>`
            codefile_select.value = name
            demoWorkspace.clear()
            saveToRoblox()
        }

        function onBloxScriptDeleted(event_data) {
            refresh()
        }

        async function getConnectionInfo(code) {
            const resp = await fetch(backendUrl + "/codes/" + code)
            return await resp.json()
        }



        async function onConnect() {
            let code;
            while (!connectionInfo) {
                code = prompt("Please enter the code from roblox studio:");
                if (!code) {
                    return;
                }
                connectionInfo = await getConnectionInfo(code)
            }
            document.getElementById("controls").style = "display: block";
            document.getElementById("connect").style = "display: none"
            refresh()

            window.setInterval(async() => {
                // TODO: figure out how to pass authcode
                let resp = await fetch(`${backendUrl}/messages/${connectionInfo.queues.blox}`, {
                    headers: {
                        authcode: connectionInfo.auth_code
                    }
                });
                const result = await resp.json()
                if (result.messages.length > 0) {
                    for (let message of result.messages) {
                        console.log(message);
                        switch (message.event_type) {
                            case "GlobalBloxScriptDeleted":
                                onBloxScriptDeleted(message.event_data);
                                break;
                            case "GlobalBloxScripts":
                                onRefresh(message.event_data)
                                break
                            case "GlobalBloxScriptCreated":
                                onBloxScriptCreated(message.event_data);
                                break;
                            case "GlobalBloxScript":
                                onCodefileReturned(message.event_data)
                                break
                        }
                    }
                }
            }, 1000);

        }

        document.getElementById("connect").addEventListener("click", onConnect)
    </script>

</body>

</html>